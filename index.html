<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accountify - GST Accounting</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- jsPDF & AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <!-- Alpine.js for lightweight reactivity -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .sidebar-link {
      @apply block px-4 py-2 text-sm rounded-md transition-colors;
    }

    .sidebar-link:hover,
    .sidebar-link.active {
      @apply bg-blue-50 text-blue-700;
    }

    .btn {
      @apply inline-flex items-center justify-center px-4 py-2 rounded-md font-medium text-sm transition;
    }

    .btn-primary {
      @apply bg-blue-600 hover:bg-blue-700 text-white;
    }

    .btn-outline {
      @apply border border-gray-300 bg-white text-gray-700 hover:bg-gray-50;
    }

    .card {
      @apply bg-white border border-gray-200 rounded-lg shadow-sm p-6;
    }

    .input,
    .select {
      @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500;
    }

    .hidden {
      display: none !important;
    }

    .toast {
      @apply fixed top-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900" x-data="app">

  <!-- Toast Notification -->
  <div class="toast hidden" id="toast">Saved successfully!</div>

  <!-- Auth Screen -->
  <div id="authScreen" class="flex items-center justify-center min-h-screen">
    <div class="p-8 bg-white rounded-xl shadow-lg max-w-md w-full text-center border">
      <div
        class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-4">
        A</div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Accountify</h1>
      <p class="text-gray-600 mb-6">Modern GST Accounting for Indian Businesses</p>
      <button @click="signIn" class="btn btn-primary w-full">Sign In with Google</button>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r min-h-screen p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-8">Accountify</h2>
      <nav class="space-y-2">
        <a href="#" @click="activeTab='dashboard'" :class="{ 'active': activeTab === 'dashboard' }"
          class="sidebar-link">üìä Dashboard</a>
        <a href="#" @click="loadCompanies(); activeTab='companies'" :class="{ 'active': activeTab === 'companies' }"
          class="sidebar-link">üè¢ Companies</a>
        <a href="#" @click="loadParties(); activeTab='parties'" :class="{ 'active': activeTab === 'parties' }"
          class="sidebar-link">üë• Parties</a>
        <a href="#" @click="loadProducts(); activeTab='products'" :class="{ 'active': activeTab === 'products' }"
          class="sidebar-link">üì¶ Products</a>
        <a href="#" @click="loadInvoices(); activeTab='invoices'" :class="{ 'active': activeTab === 'invoices' }"
          class="sidebar-link">üßæ Invoices</a>
        <a href="#" @click="loadPurchases(); activeTab='purchases'" :class="{ 'active': activeTab === 'purchases' }"
          class="sidebar-link">üì• Purchases</a>
        <a href="#" @click="generateLedger(); activeTab='ledger'" :class="{ 'active': activeTab === 'ledger' }"
          class="sidebar-link">üìí Ledger</a>
        <a href="#" @click="generateGSTReport(); activeTab='gst'" :class="{ 'active': activeTab === 'gst' }"
          class="sidebar-link"> taxpaid GSTR-1</a>
      </nav>
      <div class="absolute bottom-6 left-6 right-6">
        <button @click="signOut" class="btn btn-outline w-full text-sm">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-auto">
      <template x-if="activeTab === 'dashboard'">
        <div>
          <h1 class="text-2xl font-bold mb-6">Dashboard</h1>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card">
              <div class="text-sm text-gray-500">Total Invoices</div>
              <div class="text-2xl font-bold mt-1" x-text="stats.invoices"></div>
              <div class="text-green-600 text-sm mt-1">+12% from last month</div>
            </div>
            <div class="card">
              <div class="text-sm text-gray-500">Total Revenue</div>
              <div class="text-2xl font-bold mt-1">‚Çπ<span x-text="stats.revenue"></span></div>
              <div class="text-green-600 text-sm mt-1">+18% from last month</div>
            </div>
            <div class="card">
              <div class="text-sm text-gray-500">Pending Payments</div>
              <div class="text-2xl font-bold mt-1">‚Çπ<span x-text="stats.pending"></span></div>
              <div class="text-red-600 text-sm mt-1">3 overdue</div>
            </div>
            <div class="card">
              <div class="text-sm text-gray-500">GST Payable</div>
              <div class="text-2xl font-bold mt-1">‚Çπ<span x-text="stats.gstPayable"></span></div>
              <div class="text-blue-600 text-sm mt-1">Due by 20th</div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card">
              <h2 class="text-lg font-semibold mb-4">Recent Invoices</h2>
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-gray-500 border-b">
                    <th class="pb-2">Invoice #</th>
                    <th class="pb-2">Date</th>
                    <th class="pb-2">Customer</th>
                    <th class="pb-2 text-right">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="inv in recentInvoices" :key="inv.id">
                    <tr class="border-b">
                      <td class="py-2" x-text="inv.number"></td>
                      <td class="py-2" x-text="inv.date"></td>
                      <td class="py-2" x-text="inv.partyName"></td>
                      <td class="py-2 text-right">‚Çπ<span x-text="inv.total"></span></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <div class="card">
              <h2 class="text-lg font-semibold mb-4">Quick Actions</h2>
              <div class="space-y-3">
                <button @click="activeTab='invoices'; showModal('invoiceModal')"
                  class="btn btn-primary w-full justify-start">+ Create Invoice</button>
                <button @click="activeTab='purchases'; showModal('purchaseModal')"
                  class="btn btn-outline w-full justify-start">+ Record Purchase</button>
                <button @click="activeTab='parties'; showModal('partyModal')"
                  class="btn btn-outline w-full justify-start">+ Add Customer/Vendor</button>
              </div>
            </div>
          </div>
        </div>
      </template>

      <!-- Companies -->
      <template x-if="activeTab === 'companies'">
        <div>
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Companies</h1>
            <button @click="showModal('companyModal')" class="btn btn-primary">+ Add Company</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="company in companies" :key="company.id">
              <div class="card">
                <h3 class="font-semibold" x-text="company.name"></h3>
                <p class="text-sm text-gray-600" x-text="company.gstin"></p>
                <p class="text-sm text-gray-600" x-text="company.address"></p>
                <div class="mt-4 flex justify-end">
                  <button @click="editCompany(company)" class="text-blue-600 text-sm">Edit</button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>

      <!-- Invoices -->
      <template x-if="activeTab === 'invoices'">
        <div>
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Invoices</h1>
            <button @click="resetInvoice(); showModal('invoiceModal')" class="btn btn-primary">+ New Invoice</button>
          </div>
          <div class="card">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="pb-2">No</th>
                  <th class="pb-2">Date</th>
                  <th class="pb-2">Party</th>
                  <th class="pb-2">Total</th>
                  <th class="pb-2">GST</th>
                  <th class="pb-2">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(inv, index) in invoices" :key="inv.id">
                  <tr class="border-b">
                    <td class="py-2" x-text="index + 1"></td>
                    <td class="py-2" x-text="inv.date"></td>
                    <td class="py-2" x-text="inv.partyName"></td>
                    <td class="py-2">‚Çπ<span x-text="inv.total"></span></td>
                    <td class="py-2">‚Çπ<span x-text="inv.gstAmount"></span></td>
                    <td class="py-2 space-x-2">
                      <button @click="downloadInvoice(inv)" class="text-blue-600 text-xs">PDF</button>
                      <button @click="deleteInvoice(inv.id)" class="text-red-600 text-xs">Del</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </template>

      <!-- GST Report -->
      <template x-if="activeTab === 'gst'">
        <div>
          <h1 class="text-2xl font-bold mb-6">GSTR-1 Report</h1>
          <button @click="generateGSTReport" class="btn btn-primary mb-6">Generate Report</button>
          <template x-if="gstReport">
            <div class="card">
              <h3 class="text-lg font-semibold mb-4">Summary (Tax Period: Apr 2024 - Mar 2025)</h3>
              <div class="grid grid-cols-2 gap-6 mb-6">
                <div>
                  <div class="text-sm text-gray-500">Total Taxable Value</div>
                  <div class="text-xl font-bold">‚Çπ<span x-text="gstReport.taxable"></span></div>
                </div>
                <div>
                  <div class="text-sm text-gray-500">Total GST</div>
                  <div class="text-xl font-bold">‚Çπ<span x-text="gstReport.totalGst"></span></div>
                </div>
                <div>
                  <div class="text-sm text-gray-500">IGST</div>
                  <div class="text-lg">‚Çπ<span x-text="gstReport.igst"></span></div>
                </div>
                <div>
                  <div class="text-sm text-gray-500">CGST + SGST</div>
                  <div class="text-lg">‚Çπ<span x-text="gstReport.csgst"></span></div>
                </div>
              </div>
              <button @click="exportGSTReport" class="btn btn-primary">Export as PDF</button>
            </div>
          </template>
        </div>
      </template>
    </main>
  </div>

  <!-- Modals -->
  <!-- Invoice Modal -->
  <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg w-full max-w-3xl max-h-96 overflow-y-auto">
      <h3 class="text-lg font-semibold mb-4">Create Invoice</h3>
      <form @submit.prevent="saveInvoice">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium mb-1">Company</label>
            <select x-model="formData.companyId" class="select" required>
              <option value="">Select</option>
              <template x-for="c in companies" :key="c.id">
                <option :value="c.id" x-text="c.name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Customer</label>
            <select x-model="formData.partyId" class="select" required>
              <option value="">Select</option>
              <template x-for="p in parties" :key="p.id">
                <option :value="p.id" x-text="p.name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Date</label>
            <input type="date" x-model="formData.date" class="input" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Due Date</label>
            <input type="date" x-model="formData.dueDate" class="input" required />
          </div>
        </div>

        <div class="mb-4">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b">
                <th class="text-left pb-2">Item</th>
                <th class="text-left pb-2">Qty</th>
                <th class="text-left pb-2">Rate</th>
                <th class="text-left pb-2">Amount</th>
                <th class="text-left pb-2">GST%</th>
                <th class="text-left pb-2">Total</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(item, index) in formData.items" :key="index">
                <tr>
                  <td class="py-1">
                    <select @change="onItemSelect($event, index)" class="input text-sm">
                      <option value="">Select</option>
                      <template x-for="p in products" :key="p.id">
                        <option :value="p.id" :data-rate="p.rate" :data-gst="p.gst" x-text="p.name"></option>
                      </template>
                    </select>
                  </td>
                  <td class="py-1"><input type="number" step="0.01" x-model="item.qty" @input="recalculate"
                      class="input text-sm w-20" /></td>
                  <td class="py-1"><input type="number" step="0.01" x-model="item.rate" @input="recalculate"
                      class="input text-sm w-24" /></td>
                  <td class="py-1" x-text="Number(item.qty * item.rate).toFixed(2)"></td>
                  <td class="py-1"><input type="number" x-model="item.gst" @input="recalculate"
                      class="input text-sm w-20" /></td>
                  <td class="py-1 font-medium" x-text="item.total.toFixed(2)"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <button type="button" @click="addItem" class="text-blue-600 text-sm mt-2">+ Add Item</button>
        </div>

        <div class="flex justify-between mb-4 text-sm">
          <div>
            <div>Subtotal: ‚Çπ<span x-text="totals.subtotal.toFixed(2)"></span></div>
            <div>CGST: ‚Çπ<span x-text="totals.cgst.toFixed(2)"></span></div>
            <div>SGST: ‚Çπ<span x-text="totals.sgst.toFixed(2)"></span></div>
            <div>IGST: ‚Çπ<span x-text="totals.igst.toFixed(2)"></span></div>
          </div>
          <div class="text-right">
            <div class="font-bold">Total: ‚Çπ<span x-text="totals.total.toFixed(2)"></span></div>
          </div>
        </div>

        <div class="flex justify-end space-x-2">
          <button type="button" @click="hideModal('invoiceModal')" class="btn btn-outline">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        activeTab: 'dashboard',
        companies: [],
        parties: [],
        products: [],
        invoices: [],
        purchases: [],
        ledgers: [],
        gstReport: null,
        stats: { invoices: 0, revenue: 0, pending: 0, gstPayable: 0 },
        recentInvoices: [],
        formData: {
          companyId: '',
          partyId: '',
          date: new Date().toISOString().split('T')[0],
          dueDate: new Date().toISOString().split('T')[0],
          items: [{ name: '', qty: 1, rate: 0, gst: 18, total: 0 }]
        },
        totals: { subtotal: 0, cgst: 0, sgst: 0, igst: 0, total: 0 },

        async signIn() {
          const provider = new firebase.auth.GoogleAuthProvider();
          try {
            await firebase.auth().signInWithPopup(provider);
            this.loadDashboardData();
          } catch (err) {
            alert(err.message);
          }
        },

        signOut() {
          firebase.auth().signOut();
          window.location.reload();
        },

        async loadDashboardData() {
          await this.loadInvoices();
          await this.loadCompanies();
          await this.loadParties();
          await this.loadProducts();

          this.stats.invoices = this.invoices.length;
          this.stats.revenue = this.invoices.reduce((sum, i) => sum + parseFloat(i.total), 0).toFixed(2);
          this.stats.pending = this.invoices
            .filter(i => !i.paid)
            .reduce((sum, i) => sum + parseFloat(i.total), 0)
            .toFixed(2);
          this.stats.gstPayable = this.invoices
            .reduce((sum, i) => sum + parseFloat(i.gstAmount || 0), 0)
            .toFixed(2);

          this.recentInvoices = this.invoices.slice(0, 5);
        },

        async loadCompanies() {
          const snapshot = await db.collection('companies').where('userId', '==', auth.currentUser.uid).get();
          this.companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        },

        async loadParties() {
          const snapshot = await db.collection('parties').where('userId', '==', auth.currentUser.uid).get();
          this.parties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        },

        async loadProducts() {
          const snapshot = await db.collection('products').where('userId', '==', auth.currentUser.uid).get();
          this.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        },

        async loadInvoices() {
          const snapshot = await db.collection('invoices').where('userId', '==', auth.currentUser.uid).get();
          this.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        },

        addItem() {
          this.formData.items.push({ name: '', qty: 1, rate: 0, gst: 18, total: 0 });
        },

        onItemSelect(e, index) {
          const option = e.target.selectedOptions[0];
          const rate = option.getAttribute('data-rate');
          const gst = option.getAttribute('data-gst');
          this.formData.items[index].rate = parseFloat(rate) || 0;
          this.formData.items[index].gst = parseFloat(gst) || 0;
          this.recalculate();
        },

        recalculate() {
          let subtotal = 0, cgst = 0, sgst = 0, igst = 0;
          this.formData.items.forEach(item => {
            const amount = item.qty * item.rate;
            const gstAmount = amount * (item.gst / 100);
            item.total = amount + gstAmount;
            subtotal += amount;

            const party = this.parties.find(p => p.id === this.formData.partyId);
            const company = this.companies.find(c => c.id === this.formData.companyId);
            if (party && company && company.gstin.slice(0, 2) !== party.gstin.slice(0, 2)) {
              igst += gstAmount;
            } else {
              cgst += gstAmount / 2;
              sgst += gstAmount / 2;
            }
          });

          this.totals = { subtotal, cgst, sgst, igst, total: subtotal + cgst + sgst + igst };
        },

        resetInvoice() {
          this.formData = {
            companyId: '', partyId: '',
            date: new Date().toISOString().split('T')[0],
            dueDate: new Date().toISOString().split('T')[0],
            items: [{ name: '', qty: 1, rate: 0, gst: 18, total: 0 }]
          };
          this.totals = { subtotal: 0, cgst: 0, sgst: 0, igst: 0, total: 0 };
        },

        async saveInvoice() {
          const data = { ...this.formData, ...this.totals, userId: auth.currentUser.uid, createdAt: new Date() };
          await db.collection('invoices').add(data);
          this.showToast("Invoice saved!");
          this.hideModal('invoiceModal');
          await this.loadInvoices();
          this.loadDashboardData();
        },

        async deleteInvoice(id) {
          if (confirm("Delete this invoice?")) {
            await db.collection('invoices').doc(id).delete();
            this.showToast("Invoice deleted");
            this.loadInvoices();
          }
        },

        async generateGSTReport() {
          let taxable = 0, igst = 0, cgst = 0, sgst = 0;
          this.invoices.forEach(inv => {
            inv.items.forEach(item => {
              const amount = item.qty * item.rate;
              taxable += amount;
              const gst = amount * (item.gst / 100);
              if (inv.gstType === 'igst') igst += gst;
              else { cgst += gst / 2; sgst += gst / 2; }
            });
          });
          this.gstReport = {
            taxable: taxable.toFixed(2),
            igst: igst.toFixed(2),
            csgst: (cgst + sgst).toFixed(2),
            totalGst: (igst + cgst + sgst).toFixed(2)
          };
        },

        exportGSTReport() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text("GSTR-1 Report", 14, 16);
          doc.autoTable({
            startY: 20,
            head: [['Description', 'Amount (‚Çπ)']],
            body: [
              ['Taxable Value', this.gstReport.taxable],
              ['IGST', this.gstReport.igst],
              ['CGST + SGST', this.gstReport.csgst],
              ['Total GST', this.gstReport.totalGst]
            ]
          });
          doc.save("gstr1-report.pdf");
        },

        downloadInvoice(inv) {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text(`Invoice: ${inv.number || 'INV-001'}`, 14, 16);
          doc.autoTable({
            startY: 20,
            columns: ['Item', 'Qty', 'Rate', 'GST%', 'Total'].map(col => ({ header: col, dataKey: col.toLowerCase() })),
            body: inv.items.map(i => [i.name, i.qty, i.rate, i.gst, i.total])
          });
          doc.save(`INV-${inv.id}.pdf`);
        },

        showModal(id) { document.getElementById(id).classList.remove('hidden'); },
        hideModal(id) { document.getElementById(id).classList.add('hidden'); },
        showToast(msg) {
          const toast = document.getElementById('toast');
          toast.textContent = msg;
          toast.classList.remove('hidden');
          setTimeout(() => toast.classList.add('hidden'), 3000);
        }
      }));
    });

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyASGOM7eD3S-vTXpo869ctfbIk2jzqUbXY",
      authDomain: "pocketretail-742e1.firebaseapp.com",
      projectId: "pocketretail-742e1",
      storageBucket: "pocketretail-742e1.firebasestorage.app",
      messagingSenderId: "124604480117",
      appId: "1:124604480117:web:7e387e67f02936c2b9963c",
      measurementId: "G-4QY5Y5R5KL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("authScreen").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
      } else {
        document.getElementById("authScreen").classList.remove("hidden");
        document.getElementById("app").classList.add("hidden");
      }
    });
  </script>
</body>

</html>

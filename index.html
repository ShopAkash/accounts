<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Accounting System</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- jsPDF for PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .hidden { display: none !important; }
    .active-tab { border-bottom: 3px solid #2563eb; color: #1e40af; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- Firebase Config -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyASGOM7eD3S-vTXpo869ctfbIk2jzqUbXY",
  authDomain: "pocketretail-742e1.firebaseapp.com",
  projectId: "pocketretail-742e1",
  storageBucket: "pocketretail-742e1.firebasestorage.app",
  messagingSenderId: "124604480117",
  appId: "1:124604480117:web:7e387e67f02936c2b9963c",
  measurementId: "G-4QY5Y5R5KL"
  };
  firebase.initializeApp(firebaseConfig);

  const db = firebase.firestore();
  const auth = firebase.auth();
  const storage = firebase.storage();

  let currentUser = null;
  let currentCompany = null;
  let currentFY = null;
</script>

<!-- Main App -->
<div id="app" class="min-h-screen flex flex-col">

  <!-- Auth Screen -->
  <div id="authScreen" class="flex flex-col items-center justify-center p-8 space-y-6">
    <h1 class="text-3xl font-bold text-blue-700">Accounting Pro</h1>
    <p class="text-gray-600">Login to manage your businesses</p>
    <button onclick="signIn()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Sign In with Google</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden flex-1 flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b px-6 py-4 flex justify-between items-center">
      <h2 class="text-xl font-semibold text-gray-800" id="companyDisplayName">No Company</h2>
      <div class="flex items-center space-x-4">
        <select id="fySelector" class="text-sm border rounded px-2 py-1" onchange="switchFY()">
          <option value="">Select FY</option>
        </select>
        <select id="companySelector" class="text-sm border rounded px-2 py-1" onchange="switchCompany()">
          <option value="">Switch Company</option>
        </select>
        <button onclick="logout()" class="text-sm text-red-600 hover:underline">Logout</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white border-b">
      <div class="flex space-x-8 px-6">
        <button class="tab-btn active-tab p-4 font-medium" data-tab="dashboardTab">Dashboard</button>
        <button class="tab-btn p-4 font-medium" data-tab="invoiceTab">Invoices</button>
        <button class="tab-btn p-4 font-medium" data-tab="purchaseTab">Purchases</button>
        <button class="tab-btn p-4 font-medium" data-tab="notesTab">Credit/Debit Notes</button>
        <button class="tab-btn p-4 font-medium" data-tab="ledgerTab">Ledgers</button>
        <button class="tab-btn p-4 font-medium" data-tab="gstTab">GST Reports</button>
        <button class="tab-btn p-4 font-medium" data-tab="settingsTab">Settings</button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="flex-1 p-6 overflow-auto">

      <!-- Dashboard Tab -->
      <div id="dashboardTab" class="tab-content">
        <h3 class="text-lg font-semibold mb-4">Welcome, <span id="userGreeting"></span></h3>
        <p class="text-gray-600">Manage your invoices, ledgers, and GST filings from one place.</p>
      </div>

      <!-- Invoice Tab -->
      <div id="invoiceTab" class="tab-content hidden">
        <div class="mb-6">
          <button onclick="showModal('invoiceModal')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">+ New Invoice</button>
        </div>
        <table class="min-w-full bg-white border rounded-lg overflow-hidden" id="invoiceTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-4 border-b">No</th>
              <th class="py-2 px-4 border-b">Date</th>
              <th class="py-2 px-4 border-b">Party</th>
              <th class="py-2 px-4 border-b">Amount</th>
              <th class="py-2 px-4 border-b">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Purchase Tab -->
      <div id="purchaseTab" class="tab-content hidden">
        <div class="mb-6">
          <button onclick="showModal('purchaseModal')" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">+ New Purchase Bill</button>
        </div>
        <table class="min-w-full bg-white border rounded-lg overflow-hidden" id="purchaseTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-4 border-b">No</th>
              <th class="py-2 px-4 border-b">Date</th>
              <th class="py-2 px-4 border-b">Vendor</th>
              <th class="py-2 px-4 border-b">Amount</th>
              <th class="py-2 px-4 border-b">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Credit/Debit Notes -->
      <div id="notesTab" class="tab-content hidden">
        <div class="mb-6">
          <button onclick="showModal('creditNoteModal')" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 mr-2">+ Credit Note</button>
          <button onclick="showModal('debitNoteModal')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">+ Debit Note</button>
        </div>
        <table class="min-w-full bg-white border rounded-lg overflow-hidden" id="notesTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-4 border-b">Type</th>
              <th class="py-2 px-4 border-b">Date</th>
              <th class="py-2 px-4 border-b">Party</th>
              <th class="py-2 px-4 border-b">Amount</th>
              <th class="py-2 px-4 border-b">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ledgers -->
      <div id="ledgerTab" class="tab-content hidden">
        <h3 class="text-lg font-semibold mb-4">Auto-Generated Ledgers</h3>
        <ul id="ledgerList" class="space-y-2"></ul>
      </div>

      <!-- GST Reports -->
      <div id="gstTab" class="tab-content hidden">
        <h3 class="text-lg font-semibold mb-4">GST Summary (GSTR-1)</h3>
        <button onclick="generateGSTReport()" class="px-4 py-2 bg-blue-600 text-white rounded mb-4">Generate Report</button>
        <div id="gstReportOutput" class="bg-gray-50 p-4 rounded border"></div>
      </div>

      <!-- Settings -->
      <div id="settingsTab" class="tab-content hidden">
        <h3 class="text-lg font-semibold mb-4">Company & Financial Year</h3>
        <button onclick="showModal('companyModal')" class="mb-4 px-4 py-2 bg-purple-600 text-white rounded">+ Add Company</button>
        <button onclick="showModal('fyModal')" class="mb-4 px-4 py-2 bg-orange-600 text-white rounded ml-2">+ Add Financial Year</button>
        <div id="settingsList" class="space-y-4"></div>
      </div>

    </div>
  </div>

  <!-- Modals -->
  <!-- Company Modal -->
  <div id="companyModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h3 class="text-lg font-bold mb-4">Add Company</h3>
      <input id="companyName" placeholder="Company Name" class="w-full p-2 border rounded mb-2"/>
      <input id="companyGST" placeholder="GSTIN" class="w-full p-2 border rounded mb-2"/>
      <input id="companyAddress" placeholder="Address" class="w-full p-2 border rounded mb-4"/>
      <div class="flex justify-end space-x-2">
        <button onclick="hideModal('companyModal')" class="px-4 py-2 text-gray-600">Cancel</button>
        <button onclick="saveCompany()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- FY Modal -->
  <div id="fyModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h3 class="text-lg font-bold mb-4">Add Financial Year</h3>
      <input id="fyName" placeholder="FY Name (e.g. 2024-25)" class="w-full p-2 border rounded mb-4"/>
      <div class="flex justify-end space-x-2">
        <button onclick="hideModal('fyModal')" class="px-4 py-2 text-gray-600">Cancel</button>
        <button onclick="saveFY()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-2/3 max-h-96 overflow-y-auto">
      <h3 class="text-lg font-bold mb-4">Create Invoice</h3>
      <input id="invParty" placeholder="Party Name" class="w-full p-2 border rounded mb-2"/>
      <input id="invGSTIN" placeholder="Party GSTIN" class="w-full p-2 border rounded mb-2"/>
      <input id="invDate" type="date" class="w-full p-2 border rounded mb-2"/>
      <div id="invItems">
        <div class="item-row flex gap-2 mb-2">
          <input placeholder="Item" class="p-2 border rounded flex-1"/>
          <input placeholder="Qty" type="number" class="p-2 border rounded w-20"/>
          <input placeholder="Rate" type="number" class="p-2 border rounded w-24"/>
          <input placeholder="GST%" type="number" class="p-2 border rounded w-20"/>
          <button onclick="removeItem(this)" class="text-red-500">✕</button>
        </div>
      </div>
      <button onclick="addItemRow()" class="text-sm text-blue-600 mb-4">+ Add Item</button>
      <div class="flex justify-end">
        <button onclick="hideModal('invoiceModal')" class="px-4 py-2 text-gray-600 mr-2">Cancel</button>
        <button onclick="saveInvoice()" class="px-4 py-2 bg-green-600 text-white rounded">Save Invoice</button>
      </div>
    </div>
  </div>

  <!-- Purchase Modal -->
  <div id="purchaseModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-2/3 max-h-96 overflow-y-auto">
      <h3 class="text-lg font-bold mb-4">Create Purchase Bill</h3>
      <input id="purVendor" placeholder="Vendor Name" class="w-full p-2 border rounded mb-2"/>
      <input id="purGSTIN" placeholder="Vendor GSTIN" class="w-full p-2 border rounded mb-2"/>
      <input id="purDate" type="date" class="w-full p-2 border rounded mb-2"/>
      <div id="purItems">
        <div class="item-row flex gap-2 mb-2">
          <input placeholder="Item" class="p-2 border rounded flex-1"/>
          <input placeholder="Qty" type="number" class="p-2 border rounded w-20"/>
          <input placeholder="Rate" type="number" class="p-2 border rounded w-24"/>
          <input placeholder="GST%" type="number" class="p-2 border rounded w-20"/>
          <button onclick="removeItem(this)" class="text-red-500">✕</button>
        </div>
      </div>
      <button onclick="addPurItemRow()" class="text-sm text-blue-600 mb-4">+ Add Item</button>
      <div class="flex justify-end">
        <button onclick="hideModal('purchaseModal')" class="px-4 py-2 text-gray-600 mr-2">Cancel</button>
        <button onclick="savePurchase()" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Bill</button>
      </div>
    </div>
  </div>

  <!-- Credit/Debit Note Modal -->
  <div id="creditNoteModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h3 class="text-lg font-bold mb-4">Credit Note</h3>
      <input id="cnParty" placeholder="Customer" class="w-full p-2 border rounded mb-2"/>
      <input id="cnDate" type="date" class="w-full p-2 border rounded mb-2"/>
      <textarea id="cnReason" placeholder="Reason" class="w-full p-2 border rounded mb-4 h-20"></textarea>
      <input id="cnAmount" type="number" placeholder="Amount" class="w-full p-2 border rounded mb-4"/>
      <div class="flex justify-end">
        <button onclick="hideModal('creditNoteModal')" class="px-4 py-2 text-gray-600 mr-2">Cancel</button>
        <button onclick="saveNote('credit')" class="px-4 py-2 bg-yellow-600 text-white rounded">Save</button>
      </div>
    </div>
  </div>

  <div id="debitNoteModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96">
      <h3 class="text-lg font-bold mb-4">Debit Note</h3>
      <input id="dnVendor" placeholder="Vendor" class="w-full p-2 border rounded mb-2"/>
      <input id="dnDate" type="date" class="w-full p-2 border rounded mb-2"/>
      <textarea id="dnReason" placeholder="Reason" class="w-full p-2 border rounded mb-4 h-20"></textarea>
      <input id="dnAmount" type="number" placeholder="Amount" class="w-full p-2 border rounded mb-4"/>
      <div class="flex justify-end">
        <button onclick="hideModal('debitNoteModal')" class="px-4 py-2 text-gray-600 mr-2">Cancel</button>
        <button onclick="saveNote('debit')" class="px-4 py-2 bg-red-600 text-white rounded">Save</button>
      </div>
    </div>
  </div>

</div>

<script>
  // Auth
  function signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(cred => {
        currentUser = cred.user;
        document.getElementById("authScreen").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        document.getElementById("userGreeting").innerText = currentUser.displayName || currentUser.email;
        loadCompanies();
        loadFYs();
      })
      .catch(err => alert(err.message));
  }

  function logout() {
    auth.signOut().then(() => {
      location.reload();
    });
  }

  // Tab Switching
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active-tab"));
      btn.classList.add("active-tab");
      const tab = btn.getAttribute("data-tab");
      document.getElementById(tab).classList.remove("hidden");
    });
  });

  // Modal
  function showModal(id) { document.getElementById(id).classList.remove("hidden"); }
  function hideModal(id) { document.getElementById(id).classList.add("hidden"); }

  // Add Item Row
  function addItemRow() {
    const container = document.getElementById("invItems");
    const row = document.createElement("div");
    row.className = "item-row flex gap-2 mb-2";
    row.innerHTML = `
      <input placeholder="Item" class="p-2 border rounded flex-1"/>
      <input placeholder="Qty" type="number" class="p-2 border rounded w-20"/>
      <input placeholder="Rate" type="number" class="p-2 border rounded w-24"/>
      <input placeholder="GST%" type="number" class="p-2 border rounded w-20"/>
      <button type="button" onclick="removeItem(this)" class="text-red-500">✕</button>
    `;
    container.appendChild(row);
  }

  function addPurItemRow() {
    const container = document.getElementById("purItems");
    const row = document.createElement("div");
    row.className = "item-row flex gap-2 mb-2";
    row.innerHTML = `
      <input placeholder="Item" class="p-2 border rounded flex-1"/>
      <input placeholder="Qty" type="number" class="p-2 border rounded w-20"/>
      <input placeholder="Rate" type="number" class="p-2 border rounded w-24"/>
      <input placeholder="GST%" type="number" class="p-2 border rounded w-20"/>
      <button type="button" onclick="removeItem(this)" class="text-red-500">✕</button>
    `;
    container.appendChild(row);
  }

  function removeItem(button) {
    button.parentElement.remove();
  }

  // Companies
  async function saveCompany() {
    const name = document.getElementById("companyName").value;
    const gstin = document.getElementById("companyGST").value;
    const address = document.getElementById("companyAddress").value;

    if (!name || !gstin) return alert("Name and GSTIN required");

    await db.collection("companies").add({
      name, gstin, address, userId: currentUser.uid, createdAt: new Date()
    });

    document.getElementById("companyName").value = "";
    document.getElementById("companyGST").value = "";
    document.getElementById("companyAddress").value = "";
    hideModal("companyModal");
    loadCompanies();
  }

  async function loadCompanies() {
    const snapshot = await db.collection("companies")
      .where("userId", "==", currentUser.uid).get();
    const selector = document.getElementById("companySelector");
    selector.innerHTML = "<option value=''>Switch Company</option>";
    snapshot.forEach(doc => {
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = doc.data().name;
      selector.appendChild(opt);
    });
  }

  async function switchCompany() {
    const cid = document.getElementById("companySelector").value;
    if (!cid) return;
    currentCompany = (await db.collection("companies").doc(cid).get()).data();
    currentCompany.id = cid;
    document.getElementById("companyDisplayName").textContent = currentCompany.name;
    loadInvoices();
    loadPurchases();
    loadNotes();
    generateLedgers();
  }

  // Financial Year
  async function saveFY() {
    const name = document.getElementById("fyName").value;
    if (!name) return alert("FY name required");
    await db.collection("fyears").add({
      name, companyId: currentCompany.id, userId: currentUser.uid, createdAt: new Date()
    });
    document.getElementById("fyName").value = "";
    hideModal("fyModal");
    loadFYs();
  }

  async function loadFYs() {
    if (!currentCompany) return;
    const snapshot = await db.collection("fyears")
      .where("companyId", "==", currentCompany.id).get();
    const selector = document.getElementById("fySelector");
    selector.innerHTML = "<option value=''>Select FY</option>";
    snapshot.forEach(doc => {
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = doc.data().name;
      selector.appendChild(opt);
    });
  }

  async function switchFY() {
    const fid = document.getElementById("fySelector").value;
    if (!fid) return;
    currentFY = fid;
    loadInvoices();
    loadPurchases();
    loadNotes();
  }

  // Invoices
  async function saveInvoice() {
    const party = document.getElementById("invParty").value;
    const gstin = document.getElementById("invGSTIN").value;
    const date = document.getElementById("invDate").value;
    const items = [];
    let total = 0;

    document.querySelectorAll("#invItems .item-row").forEach(row => {
      const inputs = row.querySelectorAll("input");
      const item = {
        name: inputs[0].value,
        qty: parseFloat(inputs[1].value) || 0,
        rate: parseFloat(inputs[2].value) || 0,
        gst: parseFloat(inputs[3].value) || 0
      };
      item.amount = item.qty * item.rate;
      const gstAmount = item.amount * (item.gst / 100);
      item.total = item.amount + gstAmount;
      total += item.total;
      items.push(item);
    });

    await db.collection("invoices").add({
      party, gstin, date, items, total, companyId: currentCompany.id, fyId: currentFY,
      userId: currentUser.uid, type: "invoice", createdAt: new Date()
    });

    hideModal("invoiceModal");
    clearForm("invItems");
    loadInvoices();
    generateLedgers();
  }

  function clearForm(id) {
    const container = document.getElementById(id);
    container.innerHTML = `<div class="item-row flex gap-2 mb-2">
      <input placeholder="Item" class="p-2 border rounded flex-1"/>
      <input placeholder="Qty" type="number" class="p-2 border rounded w-20"/>
      <input placeholder="Rate" type="number" class="p-2 border rounded w-24"/>
      <input placeholder="GST%" type="number" class="p-2 border rounded w-20"/>
      <button onclick="removeItem(this)" class="text-red-500">✕</button>
    </div>`;
  }

  async function loadInvoices() {
    if (!currentCompany || !currentFY) return;
    const snapshot = await db.collection("invoices")
      .where("companyId", "==", currentCompany.id)
      .where("fyId", "==", currentFY).get();
    const tbody = document.querySelector("#invoiceTable tbody");
    tbody.innerHTML = "";
    snapshot.forEach((doc, i) => {
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2 px-4 border-b">${i+1}</td>
        <td class="py-2 px-4 border-b">${d.date}</td>
        <td class="py-2 px-4 border-b">${d.party}</td>
        <td class="py-2 px-4 border-b">₹${d.total.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">
          <button onclick="downloadInvoice('${doc.id}')" class="text-blue-600 text-sm">PDF</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Purchases
  async function savePurchase() {
    const vendor = document.getElementById("purVendor").value;
    const gstin = document.getElementById("purGSTIN").value;
    const date = document.getElementById("purDate").value;
    const items = [];
    let total = 0;

    document.querySelectorAll("#purItems .item-row").forEach(row => {
      const inputs = row.querySelectorAll("input");
      const item = {
        name: inputs[0].value,
        qty: parseFloat(inputs[1].value) || 0,
        rate: parseFloat(inputs[2].value) || 0,
        gst: parseFloat(inputs[3].value) || 0
      };
      item.amount = item.qty * item.rate;
      const gstAmount = item.amount * (item.gst / 100);
      item.total = item.amount + gstAmount;
      total += item.total;
      items.push(item);
    });

    await db.collection("purchases").add({
      vendor, gstin, date, items, total, companyId: currentCompany.id, fyId: currentFY,
      userId: currentUser.uid, type: "purchase", createdAt: new Date()
    });

    hideModal("purchaseModal");
    clearForm("purItems");
    loadPurchases();
    generateLedgers();
  }

  async function loadPurchases() {
    if (!currentCompany || !currentFY) return;
    const snapshot = await db.collection("purchases")
      .where("companyId", "==", currentCompany.id)
      .where("fyId", "==", currentFY).get();
    const tbody = document.querySelector("#purchaseTable tbody");
    tbody.innerHTML = "";
    snapshot.forEach((doc, i) => {
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-2 px-4 border-b">${i+1}</td>
        <td class="py-2 px-4 border-b">${d.date}</td>
        <td class="py-2 px-4 border-b">${d.vendor}</td>
        <td class="py-2 px-4 border-b">₹${d.total.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">
          <button onclick="downloadPurchase('${doc.id}')" class="text-blue-600 text-sm">PDF</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Credit/Debit Notes
  async function saveNote(type) {
    const data = type === 'credit' ? {
      party: document.getElementById("cnParty").value,
      date: document.getElementById("cnDate").value,
      reason: document.getElementById("cnReason").value,
      amount: parseFloat(document.getElementById("cnAmount").value) || 0
    } : {
      vendor: document.getElementById("dnVendor").value,
      date: document.getElementById("dnDate").value,
      reason: document.getElementById("dnReason").value,
      amount: parseFloat(document.getElementById("dnAmount").value) || 0
    };

    await db.collection("notes").add({
      ...data, type, companyId: currentCompany.id, fyId: currentFY,
      userId: currentUser.uid, createdAt: new Date()
    });

    hideModal(type === 'credit' ? 'creditNoteModal' : 'debitNoteModal');
    loadNotes();
    generateLedgers();
  }

  async function loadNotes() {
    if (!currentCompany || !currentFY) return;
    const snapshot = await db.collection("notes")
      .where("companyId", "==", currentCompany.id)
      .where("fyId", "==", currentFY).get();
    const tbody = document.querySelector("#notesTable tbody");
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement("tr");
      const party = d.type === 'credit' ? d.party : d.vendor;
      tr.innerHTML = `
        <td class="py-2 px-4 border-b">${d.type === 'credit' ? 'Credit' : 'Debit'}</td>
        <td class="py-2 px-4 border-b">${d.date}</td>
        <td class="py-2 px-4 border-b">${party}</td>
        <td class="py-2 px-4 border-b">₹${d.amount.toFixed(2)}</td>
        <td class="py-2 px-4 border-b">
          <button class="text-blue-600 text-sm">PDF</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Ledgers
  function generateLedgers() {
    const ledgers = {};
    // Simplified: collect from invoices, purchases, notes
    // In real app, sync from Firestore
    ledgers["Sales"] = { type: "Income", balance: 0 };
    ledgers["Purchases"] = { type: "Expense", balance: 0 };
    ledgers["GST Payable"] = { type: "Liability", balance: 0 };
    ledgers["GST Input"] = { type: "Asset", balance: 0 };

    // This is a demo. In practice, calculate from actual data.
    document.getElementById("ledgerList").innerHTML = Object.entries(ledgers)
      .map(([name, acc]) => `<li class="p-3 border rounded"><strong>${name}</strong>: ${acc.type} - ₹${acc.balance}</li>`)
      .join("");
  }

  // GST Report
  async function generateGSTReport() {
    const snapshot = await db.collection("invoices")
      .where("companyId", "==", currentCompany.id)
      .where("fyId", "==", currentFY).get();

    let taxable = 0, igst = 0, cgst = 0, sgst = 0;

    snapshot.forEach(doc => {
      const d = doc.data();
      d.items.forEach(item => {
        taxable += item.amount;
        if (item.gst > 0) {
          const gst = item.amount * (item.gst / 100);
          if (currentCompany.gstin.slice(0,2) !== d.gstin.slice(0,2)) {
            igst += gst; // Inter-state
          } else {
            cgst += gst / 2;
            sgst += gst / 2;
          }
        }
      });
    });

    const output = document.getElementById("gstReportOutput");
    output.innerHTML = `
      <h4 class="font-semibold">GSTR-1 Summary</h4>
      <p><strong>Taxable Value:</strong> ₹${taxable.toFixed(2)}</p>
      <p><strong>IGST:</strong> ₹${igst.toFixed(2)}</p>
      <p><strong>CGST:</strong> ₹${cgst.toFixed(2)}</p>
      <p><strong>SGST:</strong> ₹${sgst.toFixed(2)}</p>
      <button onclick="exportGSTReport()" class="mt-2 px-3 py-1 bg-green-600 text-white text-sm rounded">Export PDF</button>
    `;
  }

  function exportGSTReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("GSTR-1 Report", 10, 10);
    doc.autoTable({ html: '#gstReportOutput' });
    doc.save("gstr1.pdf");
  }

  // PDF Download (simplified)
  async function downloadInvoice(id) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const inv = (await db.collection("invoices").doc(id).get()).data();
    doc.text(`Invoice - ${inv.party}`, 10, 10);
    doc.text(`Date: ${inv.date}`, 10, 20);
    doc.autoTable({
      head: [['Item', 'Qty', 'Rate', 'Amount', 'GST%', 'Total']],
      body: inv.items.map(i => [i.name, i.qty, i.rate, i.amount.toFixed(2), i.gst + '%', i.total.toFixed(2)])
    });
    doc.text(`Total: ₹${inv.total.toFixed(2)}`, 10, doc.lastAutoTable.finalY + 10);
    doc.save(`INV-${id}.pdf`);
  }

  async function downloadPurchase(id) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pur = (await db.collection("purchases").doc(id).get()).data();
    doc.text(`Purchase Bill - ${pur.vendor}`, 10, 10);
    doc.text(`Date: ${pur.date}`, 10, 20);
    doc.autoTable({
      head: [['Item', 'Qty', 'Rate', 'Amount', 'GST%', 'Total']],
      body: pur.items.map(i => [i.name, i.qty, i.rate, i.amount.toFixed(2), i.gst + '%', i.total.toFixed(2)])
    });
    doc.text(`Total: ₹${pur.total.toFixed(2)}`, 10, doc.lastAutoTable.finalY + 10);
    doc.save(`PUR-${id}.pdf`);
  }

  // Initial Load
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById("authScreen").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("userGreeting").innerText = user.displayName || user.email;
      loadCompanies();
    }
  });
</script>

</body>
</html>